{% extends "base.html" %} {% block title %}Tickets - Discord Bot Manager{%
endblock %} {% block extra_head %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/pages/tickets.css') }}"
/>
{% endblock %} {% block content %}
<div class="tickets-page">
  <div class="page-header">
    <h1>
      <i class="fas fa-ticket-alt"></i>
      Support Tickets
    </h1>
    <p class="subtitle">View and manage support tickets</p>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon open-tickets">
        <i class="fas fa-ticket-alt"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.open }}</div>
        <div class="stat-label">Open Tickets</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon closed-tickets">
        <i class="fas fa-check"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.closed }}</div>
        <div class="stat-label">Closed Tickets</div>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon total-tickets">
        <i class="fas fa-list"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.total }}</div>
        <div class="stat-label">Total Tickets</div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="filter-group">
      <label>Filter by Status:</label>
      <div class="btn-group">
        <a
          href="{{ url_for('tickets.index', status='all', type=ticket_type) }}"
          class="btn btn-sm {% if status_filter == 'all' %}btn-primary{% else %}btn-outline{% endif %}"
        >
          All
        </a>
        <a
          href="{{ url_for('tickets.index', status='open', type=ticket_type) }}"
          class="btn btn-sm {% if status_filter == 'open' %}btn-primary{% else %}btn-outline{% endif %}"
        >
          Open
        </a>
        <a
          href="{{ url_for('tickets.index', status='closed', type=ticket_type) }}"
          class="btn btn-sm {% if status_filter == 'closed' %}btn-primary{% else %}btn-outline{% endif %}"
        >
          Closed
        </a>
      </div>
    </div>

    <div class="filter-group">
      <label>Filter by Type:</label>
      <div class="btn-group">
        <a
          href="{{ url_for('tickets.index', status=status_filter, type='all') }}"
          class="btn btn-sm {% if ticket_type == 'all' %}btn-primary{% else %}btn-outline{% endif %}"
        >
          All
        </a>
        <a
          href="{{ url_for('tickets.index', status=status_filter, type='plex') }}"
          class="btn btn-sm {% if ticket_type == 'plex' %}btn-primary{% else %}btn-outline{% endif %}"
        >
          <i class="fas fa-film"></i> Plex
        </a>
        <a
          href="{{ url_for('tickets.index', status=status_filter, type='tv') }}"
          class="btn btn-sm {% if ticket_type == 'tv' %}btn-primary{% else %}btn-outline{% endif %}"
        >
          <i class="fas fa-tv"></i> TV
        </a>
      </div>
    </div>
  </div>

  <!-- Tickets Table -->
  <div class="card">
    <div class="card-header">
      <h3><i class="fas fa-list"></i> Tickets</h3>
      <div class="flex-row">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input
            type="text"
            id="ticketSearch"
            placeholder="Search tickets..."
            value="{{ search }}"
            onkeypress="handleTicketSearch(event)"
          />
        </div>
        <button
          class="btn btn-sm btn-outline"
          onclick="this.querySelector('i').classList.add('fa-spin'); window.location.reload()"
          title="Refresh"
        >
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
    </div>
    <div class="card-body">
      {% if tickets %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>User</th>
              <th>Subject</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for ticket in tickets %}
            <tr>
              <td>#{{ ticket.id }}</td>
              <td>
                <i class="fas fa-user"></i>
                {{ ticket.username }}
              </td>
              <td>{{ ticket.type or 'N/A' }}</td>
              <td>
                <span
                  class="badge badge-{{ 'success' if ticket.status == 'open' else 'secondary' }}"
                >
                  {{ ticket.status }}
                </span>
              </td>
              <td>
                {{ ticket.created_at[:16] if ticket.created_at else 'N/A' }}
              </td>
              <td>
                <div class="action-buttons">
                  <a
                    href="{{ url_for('tickets.view', ticket_id=ticket.id) }}"
                    class="btn btn-sm btn-primary"
                    title="View"
                  >
                    <i class="fas fa-eye"></i>
                  </a>
                  {% if ticket.status == 'open' %}
                  <button
                    onclick="closeTicket({{ ticket.id }})"
                    class="btn btn-sm btn-secondary"
                    title="Close"
                  >
                    <i class="fas fa-times"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state">
        <i class="fas fa-ticket-alt"></i>
        <h3>No tickets found</h3>
        <p>There are no tickets matching your filter criteria.</p>
      </div>
      {% endif %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="card-footer">
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ ((page - 1) * 10) + 1 }} - {{ [page * 10,
          total_tickets]|min }} of {{ total_tickets }} tickets
        </div>
        <div class="pagination">
          {% if page > 1 %}
          <a
            href="{{ url_for('tickets.index', status=status_filter, type=ticket_type, page=page-1) }}"
            class="btn btn-sm btn-outline"
          >
            <i class="fas fa-chevron-left"></i> Previous
          </a>
          {% endif %} {% for p in range(1, total_pages + 1) %} {% if p == page
          %}
          <span class="btn btn-sm btn-primary">{{ p }}</span>
          {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page +
          2) %}
          <a
            href="{{ url_for('tickets.index', status=status_filter, type=ticket_type, page=p) }}"
            class="btn btn-sm btn-outline"
            >{{ p }}</a
          >
          {% elif p == page - 3 or p == page + 3 %}
          <span class="btn btn-sm btn-outline disabled">...</span>
          {% endif %} {% endfor %} {% if page < total_pages %}
          <a
            href="{{ url_for('tickets.index', status=status_filter, type=ticket_type, page=page+1) }}"
            class="btn btn-sm btn-outline"
          >
            Next <i class="fas fa-chevron-right"></i>
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<style>
  .filters-bar {
    display: flex;
    gap: 2rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-top: 1px solid #30363d;
  }

  .pagination-info {
    color: #8b949e;
    font-size: 0.875rem;
  }

  .pagination {
    display: flex;
    gap: 0.25rem;
    align-items: center;
  }

  .pagination .disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  .card-footer {
    background: #0d1117;
    border-radius: 0 0 6px 6px;
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
  }

  .stat-icon.open-tickets {
    background: #38ef7d;
  }

  .stat-icon.closed-tickets {
    background: #8b949e;
  }

  .stat-icon.total-tickets {
    background: #667eea;
  }

  .stat-content {
    flex: 1;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 600;
    color: var(--text-color);
    line-height: 1;
  }

  .stat-label {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }
</style>

<script>
  function handleTicketSearch(event) {
    if (event.key === "Enter") {
      const search = event.target.value;
      const url = new URL(window.location.href);
      if (search) {
        url.searchParams.set("search", search);
      } else {
        url.searchParams.delete("search");
      }
      url.searchParams.set("page", "1"); // Reset to first page
      window.location.href = url.toString();
    }
  }

  function closeTicket(ticketId) {
    if (!confirm("Are you sure you want to close this ticket?")) {
      return;
    }

    fetch(`/tickets/${ticketId}/close`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification("Ticket closed successfully", "success");
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showNotification("Error: " + data.message, "error");
        }
      })
      .catch((err) => {
        console.error("Error closing ticket:", err);
        showNotification("Failed to close ticket", "error");
      });
  }
</script>
{% endblock %}
