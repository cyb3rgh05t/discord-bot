{% extends "base.html" %} {% block title %}Members & Roles - Discord Bot
Manager{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/members.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/utilities.css') }}">
{% endblock %}

{% block content %}
<div class="members-page">
  <div class="page-header">
    <h1>
      <i class="fas fa-users"></i>
      Members & Roles
    </h1>
    <p class="subtitle">Manage member roles and permissions</p>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon members">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">{{ total_members }}</div>
        <div class="stat-label">Total Members</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon roles">
        <i class="fas fa-shield-alt"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">{{ total_roles }}</div>
        <div class="stat-label">Total Roles</div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-button active" data-tab="members">
      <i class="fas fa-users"></i> Members
    </button>
    <button class="tab-button" data-tab="roles">
      <i class="fas fa-shield-alt"></i> Roles
    </button>
  </div>

  <!-- Members Tab -->
  <div class="tab-content active" id="members-tab">
    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-users"></i> Guild Members</h3>
        <div class="flex-row">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input
              type="text"
              id="memberSearch"
              placeholder="Search members..."
              value="{{ search }}"
              onkeypress="handleMemberSearch(event)"
            />
          </div>
          <button
            class="btn btn-sm btn-outline"
            onclick="this.querySelector('i').classList.add('fa-spin'); window.location.reload()"
            title="Refresh"
          >
            <i class="fas fa-sync-alt"></i> Refresh
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="data-table">
            <thead>
              <tr>
                <th>Member</th>
                <th>Status</th>
                <th>Roles</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="membersTableBody">
              {% for member in members %}
              <tr data-member-name="{{ member.name|lower }}">
                <td>
                  <div class="member-info">
                    {% if member.avatar %}
                    <img
                      src="{{ member.avatar }}"
                      alt="{{ member.name }}"
                      class="member-avatar"
                    />
                    {% else %}
                    <div class="member-avatar-placeholder">
                      <i class="fas fa-user"></i>
                    </div>
                    {% endif %}
                    <div>
                      <div class="member-name">{{ member.name }}</div>
                      <div class="member-id">ID: {{ member.id }}</div>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="status-badge status-{{ member.status }}">
                    <i class="fas fa-circle"></i> {{ member.status }}
                  </span>
                </td>
                <td>
                  <div class="role-badges" id="member-roles-{{ member.id }}">
                    {% for role in member.roles %}
                    <span
                      class="role-badge"
                      style="background-color: {{ role.color }};"
                      data-role-id="{{ role.id }}"
                    >
                      {{ role.name }}
                      <button
                        class="role-remove-btn"
                        onclick="removeRole('{{ member.id }}', '{{ role.id }}')"
                        title="Remove role"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </span>
                    {% endfor %}
                  </div>
                </td>
                <td>
                  <button
                    class="btn btn-sm btn-primary"
                    onclick="openAddRoleModal('{{ member.id }}', '{{ member.name }}')"
                  >
                    <i class="fas fa-plus"></i> Add Role
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
        
        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="card-footer">
          <div class="pagination-container">
            <div class="pagination-info">
              Showing {{ ((page - 1) * per_page) + 1 }} - {{ [page * per_page, total_members]|min }} of {{ total_members }} members
            </div>
            <div class="pagination">
              {% if page > 1 %}
              <a href="?page={{ page - 1 }}" class="btn btn-sm btn-outline">
                <i class="fas fa-chevron-left"></i> Previous
              </a>
              {% endif %}
              
              {% for p in range(1, total_pages + 1) %}
                {% if p == page %}
                  <span class="btn btn-sm btn-primary">{{ p }}</span>
                {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %}
                  <a href="?page={{ p }}" class="btn btn-sm btn-outline">{{ p }}</a>
                {% elif p == page - 3 or p == page + 3 %}
                  <span class="btn btn-sm btn-outline disabled">...</span>
                {% endif %}
              {% endfor %}
              
              {% if page < total_pages %}
              <a href="?page={{ page + 1 }}" class="btn btn-sm btn-outline">
                Next <i class="fas fa-chevron-right"></i>
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Roles Tab -->
  <div class="tab-content" id="roles-tab">
    <div class="card">
      <div class="card-header">
        <h3><i class="fas fa-shield-alt"></i> Server Roles</h3>
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="roleSearch" placeholder="Search roles..." />
        </div>
      </div>
      <div class="card-body">
        <div class="roles-grid">
          {% for role in roles %}
          <div class="role-card" data-role-name="{{ role.name|lower }}">
            <div
              class="role-card-header"
              style="border-left: 4px solid {{ role.color }};"
            >
              <div class="role-name" style="color: {{ role.color }};">
                <i class="fas fa-shield-alt"></i>
                {{ role.name }}
              </div>
              <div class="role-member-count">
                <i class="fas fa-users"></i> {{ role.member_count }} members
              </div>
            </div>
            <div class="role-card-body">
              <div class="role-details">
                <div class="role-detail">
                  <span class="label">Position:</span>
                  <span class="value">{{ role.position }}</span>
                </div>
                <div class="role-detail">
                  <span class="label">Mentionable:</span>
                  <span class="value">
                    {% if role.mentionable %}
                    <i class="fas fa-check text-success"></i>
                    {% else %}
                    <i class="fas fa-times text-muted"></i>
                    {% endif %}
                  </span>
                </div>
                <div class="role-detail">
                  <span class="label">Hoisted:</span>
                  <span class="value">
                    {% if role.hoist %}
                    <i class="fas fa-check text-success"></i>
                    {% else %}
                    <i class="fas fa-times text-muted"></i>
                    {% endif %}
                  </span>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Role Modal -->
<div class="modal" id="addRoleModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>
        <i class="fas fa-plus-circle"></i> Add Role to
        <span id="modalMemberName"></span>
      </h3>
      <button class="modal-close" onclick="closeAddRoleModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="modalMemberId" />
      <div class="form-group">
        <label for="roleSelect">Select Role:</label>
        <select id="roleSelect" class="form-control">
          <option value="">-- Select a role --</option>
          {% for role in roles %}
          <option value="{{ role.id }}" style="color: {{ role.color }};">
            {{ role.name }}
          </option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeAddRoleModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
      <button class="btn btn-primary" onclick="confirmAddRole()">
        <i class="fas fa-check"></i> Add Role
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  // Tab switching
  document.querySelectorAll(".tab-button").forEach((button) => {
    button.addEventListener("click", () => {
      const tabName = button.dataset.tab;

      // Update buttons
      document
        .querySelectorAll(".tab-button")
        .forEach((btn) => btn.classList.remove("active"));
      button.classList.add("active");

      // Update content
      document
        .querySelectorAll(".tab-content")
        .forEach((content) => content.classList.remove("active"));
      document.getElementById(tabName + "-tab").classList.add("active");
    });
  });

  // Member search - server-side
  function handleMemberSearch(event) {
    if (event.key === "Enter") {
      const search = event.target.value;
      const url = new URL(window.location.href);
      if (search) {
        url.searchParams.set('search', search);
      } else {
        url.searchParams.delete('search');
      }
      url.searchParams.set('page', '1'); // Reset to first page
      window.location.href = url.toString();
    }
  }

  // Role search - client-side (no pagination)
  document.getElementById("roleSearch")?.addEventListener("input", (e) => {
    const search = e.target.value.toLowerCase();
    document.querySelectorAll(".role-card").forEach((card) => {
      const name = card.dataset.roleName;
      card.style.display = name.includes(search) ? "" : "none";
    });
  });

  // Modal functions
  function openAddRoleModal(memberId, memberName) {
    document.getElementById("modalMemberId").value = memberId;
    document.getElementById("modalMemberName").textContent = memberName;
    document.getElementById("roleSelect").value = "";
    document.getElementById("addRoleModal").classList.add("show");
  }

  function closeAddRoleModal() {
    document.getElementById("addRoleModal").classList.remove("show");
  }

  // Add role
  async function confirmAddRole() {
    const memberId = document.getElementById("modalMemberId").value;
    const roleId = document.getElementById("roleSelect").value;

    if (!roleId) {
      showNotification("Please select a role", "error");
      return;
    }

    try {
      const response = await fetch("/members/add_role", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          user_id: memberId,
          role_id: roleId,
        }),
      });

      const result = await response.json();

      if (result.success) {
        showNotification("Role added successfully", "success");
        closeAddRoleModal();
        // Reload page to update role display
        setTimeout(() => location.reload(), 1000);
      } else {
        showNotification(result.error || "Failed to add role", "error");
      }
    } catch (error) {
      showNotification("Error: " + error.message, "error");
    }
  }

  // Remove role
  async function removeRole(memberId, roleId) {
    if (!confirm("Are you sure you want to remove this role?")) {
      return;
    }

    try {
      const response = await fetch("/members/remove_role", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          user_id: memberId,
          role_id: roleId,
        }),
      });

      const result = await response.json();

      if (result.success) {
        showNotification("Role removed successfully", "success");
        // Reload page to update role display
        setTimeout(() => location.reload(), 1000);
      } else {
        showNotification(result.error || "Failed to remove role", "error");
      }
    } catch (error) {
      showNotification("Error: " + error.message, "error");
    }
  }

  // Close modal on outside click
  document.getElementById("addRoleModal").addEventListener("click", (e) => {
    if (e.target.id === "addRoleModal") {
      closeAddRoleModal();
    }
  });
</script>

{% endblock %}
