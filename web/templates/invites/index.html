{% extends "base.html" %} {% block title %}Invites - Discord Bot Manager{%
endblock %} {% block content %}
<div class="invites-page">
  <div class="page-header">
    <h1>
      <i class="fas fa-user-plus"></i>
      Plex Invites
    </h1>
    <p class="subtitle">Manage Plex user invitations</p>
  </div>

  <!-- Statistics -->
  <div class="stats-cards">
    <div class="stat-card">
      <div class="stat-icon total-invites">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.total }}</div>
        <div class="stat-label">Total Invites</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon active-invites">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.active }}</div>
        <div class="stat-label">Active</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon expired-invites">
        <i class="fas fa-times-circle"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.expired }}</div>
        <div class="stat-label">Expired</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon revoked-invites">
        <i class="fas fa-user-slash"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.revoked }}</div>
        <div class="stat-label">Revoked</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon removed-invites">
        <i class="fas fa-user-times"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.removed }}</div>
        <div class="stat-label">Removed</div>
      </div>
    </div>
    <div class="stat-card">
      <div
        class="stat-icon {{ 'success' if plex_stats.connected else 'warning' }}"
      >
        <i class="fas fa-server"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">
          {{ plex_stats.users if plex_stats.connected else 'N/A' }}
        </div>
        <div class="stat-label">Plex Users</div>
      </div>
    </div>
  </div>

  <!-- Plex Server Status -->
  {% if plex_stats.connected %}
  <div class="card plex-stats">
    <div class="card-header">
      <h3><i class="fas fa-server"></i> Plex Server Status</h3>
      <span class="server-name">{{ plex_stats.server_name }}</span>
    </div>
    <div class="card-body">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon plex-movies">
            <i class="fas fa-film"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ plex_stats.movies }}</div>
            <div class="stat-label">Movies</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon plex-shows">
            <i class="fas fa-tv"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ plex_stats.shows }}</div>
            <div class="stat-label">TV Shows</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon plex-users">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ plex_stats.users }}</div>
            <div class="stat-label">Users</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon plex-version">
            <i class="fas fa-code-branch"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value" style="font-size: 1rem">
              {{ plex_stats.version }}
            </div>
            <div class="stat-label">Version</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Add Invite Form -->
  <div class="card">
    <div class="card-header">
      <h3><i class="fas fa-plus"></i> Add New Invite</h3>
    </div>
    <div class="card-body">
      <form
        method="POST"
        action="{{ url_for('invites.add') }}"
        class="invite-form"
      >
        <div class="form-row">
          <div class="form-group">
            <label for="email">
              <i class="fas fa-envelope"></i> Email Address
            </label>
            <input
              type="email"
              id="email"
              name="email"
              class="form-control"
              placeholder="user@example.com"
              required
            />
          </div>
          <div class="form-group">
            <label for="discord_user">
              <i class="fab fa-discord"></i> Discord Username
            </label>
            <input
              type="text"
              id="discord_user"
              name="discord_user"
              class="form-control"
              placeholder="Username#1234"
              required
            />
          </div>
          <div class="form-group form-actions">
            <label>&nbsp;</label>
            <button
              style="margin-bottom: 4px"
              type="submit"
              class="btn btn-primary"
            >
              <i class="fas fa-plus"></i> Add Invite
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Invites Table -->
  <div class="card">
    <div class="card-header">
      <h3><i class="fas fa-list"></i> All Invites ({{ total_invites }})</h3>
      <div style="display: flex; gap: 1rem; align-items: center">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input
            type="text"
            id="inviteSearch"
            placeholder="Search by email or username..."
            value="{{ search }}"
            onkeyup="handleSearch(event)"
          />
        </div>
        <button
          class="btn btn-sm btn-outline"
          onclick="this.querySelector('i').classList.add('fa-spin'); window.location.reload()"
          title="Refresh"
        >
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
    </div>
    <div class="card-body">
      {% if invites %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Email</th>
              <th>Discord User</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for invite in invites %}
            <tr>
              <td>#{{ invite.id }}</td>
              <td>
                <i class="fas fa-envelope"></i>
                {{ invite.email }}
              </td>
              <td>
                <i class="fab fa-discord"></i>
                {{ invite.discord_user }}
              </td>
              <td>
                {% if invite.status == 'active' %}
                <span class="badge badge-success">
                  <i class="fas fa-check-circle"></i> Active
                </span>
                {% elif invite.status == 'expired' %}
                <span class="badge badge-secondary">
                  <i class="fas fa-times-circle"></i> Expired
                </span>
                {% elif invite.status == 'revoked' %}
                <span class="badge badge-warning">
                  <i class="fas fa-user-slash"></i> Revoked
                </span>
                {% elif invite.status == 'removed' %}
                <span class="badge badge-danger">
                  <i class="fas fa-user-times"></i> Removed
                </span>
                {% else %}
                <span class="badge badge-secondary"> {{ invite.status }} </span>
                {% endif %}
              </td>
              <td>
                {{ invite.created_at[:10] if invite.created_at else '-' }}
              </td>
              <td>
                <button
                  onclick="removeInvite({{ invite.id }})"
                  class="btn btn-sm btn-danger"
                  title="Remove"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state">
        <i class="fas fa-user-plus"></i>
        <h3>No invites found</h3>
        <p>
          {% if search %}No invites match your search.{% else %}Start by adding
          a new Plex invitation above.{% endif %}
        </p>
      </div>
      {% endif %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="card-footer">
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ ((page - 1) * per_page) + 1 }} - {{ [page * per_page,
          total_invites]|min }} of {{ total_invites }} invites
        </div>
        <div class="pagination">
          {% if page > 1 %}
          <a
            href="?page={{ page - 1 }}&search={{ search }}"
            class="btn btn-sm btn-outline"
          >
            <i class="fas fa-chevron-left"></i> Previous
          </a>
          {% endif %} {% for p in range(1, total_pages + 1) %} {% if p == page
          %}
          <span class="btn btn-sm btn-primary">{{ p }}</span>
          {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page +
          2) %}
          <a
            href="?page={{ p }}&search={{ search }}"
            class="btn btn-sm btn-outline"
            >{{ p }}</a
          >
          {% elif p == page - 3 or p == page + 3 %}
          <span class="btn btn-sm btn-outline disabled">...</span>
          {% endif %} {% endfor %} {% if page < total_pages %}
          <a
            href="?page={{ page + 1 }}&search={{ search }}"
            class="btn btn-sm btn-outline"
          >
            Next <i class="fas fa-chevron-right"></i>
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  function handleSearch(event) {
    if (event.key === "Enter") {
      const search = event.target.value;
      window.location.href = `?search=${encodeURIComponent(search)}`;
    }
  }

  function removeInvite(inviteId) {
    if (!confirm("Are you sure you want to remove this invite?")) {
      return;
    }

    fetch(`/invites/${inviteId}/remove`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification("Invite removed successfully", "success");
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showNotification("Error: " + data.message, "error");
        }
      })
      .catch((err) => {
        console.error("Error removing invite:", err);
        showNotification("Failed to remove invite", "error");
      });
  }
</script>

<style>
  .search-box {
    position: relative;
    max-width: 400px;
  }

  .search-box i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
  }

  .search-box input {
    width: 100%;
    padding: 0.75rem 1rem 0.75rem 2.5rem;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-color);
  }

  .pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-top: 1px solid #30363d;
  }

  .pagination-info {
    color: #8b949e;
    font-size: 0.875rem;
  }

  .pagination {
    display: flex;
    gap: 0.25rem;
    align-items: center;
  }

  .pagination .disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  .card-footer {
    background: #0d1117;
    border-radius: 0 0 6px 6px;
  }

  .plex-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    padding: 1rem;
  }

  .plex-info-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
  }

  .plex-info-item i {
    color: var(--link-color);
    width: 20px;
  }

  .plex-info-item strong {
    margin-right: 0.25rem;
  }

  /* Plex Server Card */
  .server-name {
    color: var(--link-color);
    font-weight: 600;
    font-size: 0.9rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .stat-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .stat-content {
    flex: 1;
  }

  .stat-value {
    font-size: 1.75rem;
    font-weight: 600;
    color: var(--text-color);
    line-height: 1;
  }

  .stat-label {
    color: var(--text-muted);
    font-size: 0.8rem;
    margin-top: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Stat card icon gradients */
  .stat-card .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
  }

  .stat-icon.total-invites {
    background: #667eea;
  }
  .stat-icon.active-invites {
    background: #38ef7d;
  }
  .stat-icon.expired-invites {
    background: #f04747;
  }
  .stat-icon.revoked-invites {
    background: #faa61a;
  }
  .stat-icon.removed-invites {
    background: #f04747;
  }
  .stat-icon.plex-users-stat {
    background: #38ef7d;
  }
  .stat-icon.plex-movies {
    background: #e5a00d;
  }
  .stat-icon.plex-shows {
    background: #9147ff;
  }
  .stat-icon.plex-users {
    background: #667eea;
  }
  .stat-icon.plex-version {
    background: #38ef7d;
  }

  .invite-form .form-group.form-actions {
    border-top: none !important;
    padding-top: 0 !important;
    margin-top: 0 !important;
  }

  .invite-form .form-group.form-actions::before {
    display: none !important;
  }
</style>
{% endblock %}
