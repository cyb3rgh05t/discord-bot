{% extends "base.html" %} {% block title %}Invites - Discord Bot Manager{%
endblock %} {% block extra_head %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/pages/invites.css') }}"
/>
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/utilities.css') }}"
/>
{% endblock %} {% block content %}
<div class="invites-page">
  <div class="page-header">
    <h1>
      <i class="fas fa-user-plus"></i>
      Plex Invites
    </h1>
    <p class="subtitle">Manage Plex user invitations</p>
  </div>

  <!-- Statistics -->
  <div class="stats-cards">
    <div class="stat-card">
      <div class="stat-icon total-invites">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.total }}</div>
        <div class="stat-label">Total Invites</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon active-invites">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.active }}</div>
        <div class="stat-label">Active</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon expired-invites">
        <i class="fas fa-times-circle"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.expired }}</div>
        <div class="stat-label">Expired</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon revoked-invites">
        <i class="fas fa-user-slash"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.revoked }}</div>
        <div class="stat-label">Revoked</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon removed-invites">
        <i class="fas fa-user-times"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.removed }}</div>
        <div class="stat-label">Removed</div>
      </div>
    </div>
    <div class="stat-card">
      <div
        class="stat-icon {{ 'success' if plex_stats.connected else 'warning' }}"
      >
        <i class="fas fa-server"></i>
      </div>
      <div class="stat-info">
        <div class="stat-value">
          {{ plex_stats.users if plex_stats.connected else 'N/A' }}
        </div>
        <div class="stat-label">Plex Users</div>
      </div>
    </div>
  </div>

  <!-- Plex Server Status -->
  {% if plex_stats.connected %}
  <div class="card plex-stats">
    <div class="card-header">
      <h3><i class="fas fa-server"></i> Plex Server Status</h3>
      <span class="server-name">{{ plex_stats.server_name }}</span>
    </div>
    <div class="card-body">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon plex-movies">
            <i class="fas fa-film"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ plex_stats.movies }}</div>
            <div class="stat-label">Movies</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon plex-shows">
            <i class="fas fa-tv"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ plex_stats.shows }}</div>
            <div class="stat-label">TV Shows</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon plex-users">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value">{{ plex_stats.users }}</div>
            <div class="stat-label">Users</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon plex-version">
            <i class="fas fa-code-branch"></i>
          </div>
          <div class="stat-content">
            <div class="stat-value stat-value-small">
              {{ plex_stats.version }}
            </div>
            <div class="stat-label">Version</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Add Invite Form -->
  <div class="card">
    <div class="card-header">
      <h3><i class="fas fa-plus"></i> Add New Invite</h3>
    </div>
    <div class="card-body">
      <form
        method="POST"
        action="{{ url_for('invites.add') }}"
        class="invite-form"
        id="addInviteForm"
      >
        <div class="form-row">
          <div class="form-group">
            <label for="email">
              <i class="fas fa-envelope"></i> Email Address
            </label>
            <input
              type="email"
              id="email"
              name="email"
              class="form-control"
              placeholder="user@example.com"
              required
            />
          </div>
          <div class="form-group">
            <label for="discord_user">
              <i class="fab fa-discord"></i> Discord Username
            </label>
            <input
              type="text"
              id="discord_user"
              name="discord_user"
              class="form-control"
              placeholder="Username#1234"
              required
            />
          </div>
          <div class="form-group form-actions">
            <label>&nbsp;</label>
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-plus"></i> Add Invite
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Invites Table -->
  <div class="card">
    <div class="card-header">
      <h3><i class="fas fa-list"></i> All Invites ({{ total_invites }})</h3>
      <div class="flex-row">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input
            type="text"
            id="inviteSearch"
            placeholder="Search by email or username..."
            value="{{ search }}"
            onkeyup="handleSearch(event)"
          />
        </div>
        <button
          class="btn btn-sm btn-outline"
          onclick="this.querySelector('i').classList.add('fa-spin'); window.location.reload()"
          title="Refresh"
        >
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
      </div>
    </div>
    <div class="card-body">
      {% if invites %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Email</th>
              <th>Discord User</th>
              <th>Status</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for invite in invites %}
            <tr>
              <td>#{{ invite.id }}</td>
              <td>
                <i class="fas fa-envelope"></i>
                {{ invite.email }}
              </td>
              <td>
                <i class="fab fa-discord"></i>
                {{ invite.discord_user }}
              </td>
              <td>
                {% if invite.status == 'active' %}
                <span class="badge badge-success">
                  <i class="fas fa-check-circle"></i> Active
                </span>
                {% elif invite.status == 'expired' %}
                <span class="badge badge-secondary">
                  <i class="fas fa-times-circle"></i> Expired
                </span>
                {% elif invite.status == 'revoked' %}
                <span class="badge badge-warning">
                  <i class="fas fa-user-slash"></i> Revoked
                </span>
                {% elif invite.status == 'removed' %}
                <span class="badge badge-danger">
                  <i class="fas fa-user-times"></i> Removed
                </span>
                {% else %}
                <span class="badge badge-secondary"> {{ invite.status }} </span>
                {% endif %}
              </td>
              <td>
                {{ invite.created_at[:10] if invite.created_at else '-' }}
              </td>
              <td>
                <button
                  onclick="removeInvite({{ invite.id }})"
                  class="btn btn-sm btn-danger"
                  title="Remove"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state">
        <i class="fas fa-user-plus"></i>
        <h3>No invites found</h3>
        <p>
          {% if search %}No invites match your search.{% else %}Start by adding
          a new Plex invitation above.{% endif %}
        </p>
      </div>
      {% endif %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="card-footer">
      <div class="pagination-container">
        <div class="pagination-info">
          Showing {{ ((page - 1) * per_page) + 1 }} - {{ [page * per_page,
          total_invites]|min }} of {{ total_invites }} invites
        </div>
        <div class="pagination">
          {% if page > 1 %}
          <a
            href="?page={{ page - 1 }}&search={{ search }}"
            class="btn btn-sm btn-outline"
          >
            <i class="fas fa-chevron-left"></i> Previous
          </a>
          {% endif %} {% for p in range(1, total_pages + 1) %} {% if p == page
          %}
          <span class="btn btn-sm btn-primary">{{ p }}</span>
          {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page +
          2) %}
          <a
            href="?page={{ p }}&search={{ search }}"
            class="btn btn-sm btn-outline"
            >{{ p }}</a
          >
          {% elif p == page - 3 or p == page + 3 %}
          <span class="btn btn-sm btn-outline disabled">...</span>
          {% endif %} {% endfor %} {% if page < total_pages %}
          <a
            href="?page={{ page + 1 }}&search={{ search }}"
            class="btn btn-sm btn-outline"
          >
            Next <i class="fas fa-chevron-right"></i>
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
  // Handle add invite form submission
  document
    .getElementById("addInviteForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(this);

      fetch(this.action, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
        },
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            showNotification(data.message, "success");
            // Reset form
            this.reset();
            // Reload page after short delay to show updated list
            setTimeout(() => window.location.reload(), 1000);
          } else {
            showNotification(data.message || "Failed to add invite", "error");
          }
        })
        .catch((err) => {
          console.error("Error adding invite:", err);
          showNotification("Failed to add invite", "error");
        });
    });

  function handleSearch(event) {
    if (event.key === "Enter") {
      const search = event.target.value;
      window.location.href = `?search=${encodeURIComponent(search)}`;
    }
  }

  function removeInvite(inviteId) {
    if (!confirm("Are you sure you want to remove this invite?")) {
      return;
    }

    fetch(`/invites/${inviteId}/remove`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showNotification("Invite removed successfully", "success");
          setTimeout(() => window.location.reload(), 1000);
        } else {
          showNotification("Error: " + data.message, "error");
        }
      })
      .catch((err) => {
        console.error("Error removing invite:", err);
        showNotification("Failed to remove invite", "error");
      });
  }
</script>
{% endblock %}
